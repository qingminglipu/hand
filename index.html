<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D æŒ¥æ‰‹ç²’å­ç³»ç»Ÿï¼ˆé«˜çµæ•ç‰ˆï¼‰</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        
        #input_video { 
            position: absolute; top: 0; left: 0; opacity: 0; z-index: -1; 
            width: 1px; height: 1px; pointer-events: none;
        }
        
        /* é¡¶éƒ¨æç¤ºæ  */
        #ui-panel {
            position: absolute; top: 20px; left: 0; right: 0;
            text-align: center; pointer-events: none; z-index: 10;
        }

        /* å½“å‰å½¢çŠ¶åç§°çš„å¤§æ ‡é¢˜ */
        #shape-name {
            font-size: 32px; font-weight: bold; color: white;
            text-shadow: 0 0 10px rgba(0,255,200,0.8);
            transition: transform 0.3s;
        }

        /* æ“ä½œæç¤º */
        .instruction {
            color: rgba(255,255,255,0.7); font-size: 14px; margin-top: 5px;
            background: rgba(0,0,0,0.4); display: inline-block;
            padding: 4px 12px; border-radius: 20px;
        }

        /* åˆ‡æ¢æ—¶çš„å¼¹çª—æç¤º (Toast) */
        #toast {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 20px 40px; border-radius: 15px;
            color: #fff; font-size: 24px; font-weight: bold;
            opacity: 0; transition: all 0.3s; pointer-events: none;
            border: 1px solid rgba(255,255,255,0.3);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 50;
        }
        #toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00ffc8; font-size: 18px; z-index: 200; text-align: center;
            background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
        }
    </style>
    <script src="https://unpkg.com/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="loading">æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...<br><span style="font-size:12px;color:#ccc">é¦–æ¬¡åŠ è½½è¾ƒæ…¢ï¼Œè¯·ç¨å€™</span></div>

    <div id="ui-panel">
        <div id="shape-name">â¤ï¸ çˆ±å¿ƒ</div>
        <div class="instruction">ğŸ‘‹ å‘å·¦/å‘å³æŒ¥æ‰‹åˆ‡æ¢å½¢çŠ¶ | ğŸ¤ æåˆæ‰‹æŒ‡ç¼©æ”¾</div>
    </div>

    <!-- åˆ‡æ¢æç¤ºæ¡† -->
    <div id="toast"></div>

    <video id="input_video" playsinline webkit-playsinline muted autoplay></video>

<script>
    // ================= é…ç½®å‚æ•° =================
    const PARTICLE_COUNT = 15000;
    const PARTICLE_SIZE = 0.25;
    
    // å½¢çŠ¶åˆ—è¡¨å®šä¹‰
    const SHAPE_LIST = [
        { key: 'heart', name: 'â¤ï¸ çˆ±å¿ƒ', color: '#ff0055' },
        { key: 'flower', name: 'ğŸŒ¸ èŠ±æœµ', color: '#ff66b2' },
        { key: 'saturn', name: 'ğŸª åœŸæ˜Ÿ', color: '#00ccff' },
        { key: 'buddha', name: 'ğŸ§˜ ä½›åƒ', color: '#ffcc00' },
        { key: 'fireworks', name: 'ğŸ† çƒŸèŠ±', color: '#aa00ff' },
        { key: 'sphere', name: 'ğŸ”® çƒä½“', color: '#00ffc8' }
    ];

    let currentShapeIndex = 0; // å½“å‰å½¢çŠ¶ç´¢å¼•
    let handInteractionFactor = 1.0;
    let targetColor = new THREE.Color(SHAPE_LIST[0].color);

    // ================= THREE.JS åˆå§‹åŒ– =================
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 25;

    const renderer = new THREE.WebGLRenderer({ antialias: false, alpha: false });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    // ================= ç²’å­ç³»ç»Ÿ =================
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(PARTICLE_COUNT * 3);
    const targetPositions = new Float32Array(PARTICLE_COUNT * 3);
    
    for (let i = 0; i < PARTICLE_COUNT * 3; i++) {
        positions[i] = (Math.random() - 0.5) * 50;
        targetPositions[i] = positions[i];
    }
    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

    const material = new THREE.PointsMaterial({
        size: PARTICLE_SIZE,
        color: targetColor,
        transparent: true,
        opacity: 0.85,
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });
    const particles = new THREE.Points(geometry, material);
    scene.add(particles);

    // ================= å½¢çŠ¶ç®—æ³• =================
    function getPointOnSphere(r) {
        const theta = Math.random() * Math.PI * 2;
        const phi = Math.acos(2 * Math.random() - 1);
        return { x: r * Math.sin(phi) * Math.cos(theta), y: r * Math.sin(phi) * Math.sin(theta), z: r * Math.cos(phi) };
    }

    const ShapeGenerators = {
        heart: () => {
            const t = Math.random() * Math.PI * 2, u = Math.random() * Math.PI;
            const x = 16 * Math.pow(Math.sin(u), 3) * Math.sin(t);
            const y = (13 * Math.cos(u) - 5 * Math.cos(2*u) - 2 * Math.cos(3*u) - Math.cos(4*u));
            const z = 16 * Math.pow(Math.sin(u), 3) * Math.cos(t) * 0.5;
            return [x * 0.6, y * 0.6, z * 0.6];
        },
        saturn: () => {
            if (Math.random() > 0.4) {
                const angle = Math.random() * Math.PI * 2, dist = 9 + Math.random() * 4;
                return [Math.cos(angle) * dist, (Math.random()-0.5)*0.5, Math.sin(angle) * dist];
            }
            const p = getPointOnSphere(5); return [p.x, p.y, p.z];
        },
        flower: () => {
            const u = Math.random() * Math.PI * 4, v = Math.random() * Math.PI * 2;
            const rad = 8 * Math.sin(3 * u);
            return [rad * Math.sin(u) * Math.cos(v), rad * Math.cos(u) * Math.cos(v) + 4, rad * Math.sin(v)];
        },
        buddha: () => {
            const r = Math.random();
            let p, yOffset;
            if (r < 0.25) { p = getPointOnSphere(2); yOffset = 6; }
            else if (r < 0.65) { p = getPointOnSphere(4.5); p.y*=0.8; yOffset = 1; }
            else { p = getPointOnSphere(6); p.y*=0.4; yOffset = -4; }
            return [p.x, p.y + yOffset, p.z];
        },
        fireworks: () => { const p = getPointOnSphere(Math.random() * 15); return [p.x, p.y, p.z]; },
        sphere: () => { const p = getPointOnSphere(10); return [p.x, p.y, p.z]; }
    };

    function updateParticlesTarget(shapeKey) {
        const generator = ShapeGenerators[shapeKey];
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const pos = generator(i);
            targetPositions[i * 3] = pos[0];
            targetPositions[i * 3 + 1] = pos[1];
            targetPositions[i * 3 + 2] = pos[2];
        }
    }
    updateParticlesTarget('heart'); // é»˜è®¤åˆå§‹å½¢çŠ¶

    // ================= åˆ‡æ¢é€»è¾‘ (Toast UI) =================
    const toast = document.getElementById('toast');
    let toastTimer;

    function showToast(text, direction) {
        toast.innerText = (direction === 'next' ? 'â© ' : 'âª ') + text;
        toast.classList.add('show');
        
        // ç¼©æ”¾ä¸€ä¸‹æ ‡é¢˜äº§ç”Ÿè§†è§‰åé¦ˆ
        const title = document.getElementById('shape-name');
        title.style.transform = "scale(1.2)";
        setTimeout(() => title.style.transform = "scale(1)", 200);

        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
            toast.classList.remove('show');
        }, 1500);
    }

    function switchShape(step) {
        // è®¡ç®—æ–°ç´¢å¼• (å¤„ç†å¾ªç¯)
        currentShapeIndex = (currentShapeIndex + step + SHAPE_LIST.length) % SHAPE_LIST.length;
        
        const shapeData = SHAPE_LIST[currentShapeIndex];
        
        // æ›´æ–° UI
        document.getElementById('shape-name').innerText = shapeData.name;
        document.getElementById('shape-name').style.color = shapeData.color;
        showToast(shapeData.name, step > 0 ? 'next' : 'prev');

        // æ›´æ–°ç²’å­ç›®æ ‡å’Œé¢œè‰²
        updateParticlesTarget(shapeData.key);
        targetColor.set(shapeData.color);
    }

    // ================= MediaPipe æ‰‹åŠ¿ä¸æŒ¥æ‰‹æ£€æµ‹ (é«˜çµæ•ä¼˜åŒ–ç‰ˆ) =================
    const videoElement = document.getElementById('input_video');
    
    // ã€ä¼˜åŒ–1ã€‘é™ä½æŒ¥æ‰‹é˜ˆå€¼ + ç¼©çŸ­å†·å´æ—¶é—´ï¼Œæå‡è§¦å‘çµæ•åº¦
    const SWIPE_THRESHOLD = 0.03; // ä»0.08é™è‡³0.03ï¼Œæ›´å°çš„ä½ç§»å°±èƒ½è§¦å‘
    const COOLDOWN_MS = 600;      // ä»1000msé™è‡³600msï¼Œåˆ‡æ¢æ›´é¢‘ç¹
    const SWIPE_WINDOW = 5;       // æ–°å¢ï¼šæŒ¥æ‰‹æ£€æµ‹çš„æ—¶é—´çª—å£ï¼ˆä¿å­˜æœ€è¿‘5å¸§çš„æ‰‹è…•ä½ç½®ï¼‰
    let wristXHistory = [];       // æ–°å¢ï¼šå­˜å‚¨æœ€è¿‘çš„æ‰‹è…•Xåæ ‡ï¼Œé¿å…å•å¸§æŠ–åŠ¨è¯¯åˆ¤
    let lastSwitchTime = 0;
    let lastWristX = null;

    // ã€ä¼˜åŒ–2ã€‘æå‡MediaPipeæ£€æµ‹é…ç½®ï¼Œé™ä½æ£€æµ‹é—¨æ§› + ä½¿ç”¨é«˜ç²¾åº¦æ¨¡å‹
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,          // ä»0å‡è‡³1ï¼Œä½¿ç”¨é«˜ç²¾åº¦æ¨¡å‹ï¼ˆæ£€æµ‹æ›´å‡†ï¼‰
        minDetectionConfidence: 0.3, // ä»0.5é™è‡³0.3ï¼Œæ›´ä½çš„ç½®ä¿¡åº¦ä¹Ÿèƒ½æ£€æµ‹åˆ°æ‰‹
        minTrackingConfidence: 0.3,  // ä»0.5é™è‡³0.3ï¼Œè·Ÿè¸ªæ›´ç¨³å®š
        selfieMode: true             // æ–°å¢ï¼šå¼ºåˆ¶è‡ªæ‹æ¨¡å¼ï¼Œé€‚é…å‰ç½®æ‘„åƒå¤´é•œåƒ
    });

    hands.onResults((results) => {
        document.getElementById('loading').style.display = 'none';
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            
            // 1. æåˆç¼©æ”¾é€»è¾‘ï¼ˆã€ä¼˜åŒ–3ã€‘æå‡ç¼©æ”¾å“åº”é€Ÿåº¦ï¼‰
            const thumb = landmarks[4];
            const index = landmarks[8];
            const dist = Math.sqrt(Math.pow(thumb.x - index.x, 2) + Math.pow(thumb.y - index.y, 2) + Math.pow(thumb.z - index.z, 2));
            // ä¼˜åŒ–ç¼©æ”¾æ˜ å°„ï¼šé™ä½åŸºç¡€é˜ˆå€¼ + æé«˜æ”¾å¤§ç³»æ•°ï¼Œç¼©æ”¾æ›´çµæ•
            let pinchFactor = (dist - 0.01) * 8; 
            pinchFactor = Math.max(0.1, Math.min(2.5, pinchFactor + 0.4));
            // åŠ å¿«å¹³æ»‘è¿‡æ¸¡é€Ÿåº¦ï¼šä»0.1å‡è‡³0.25ï¼Œç¼©æ”¾å“åº”æ›´å¿«
            handInteractionFactor += (pinchFactor - handInteractionFactor) * 0.25;

            // 2. æŒ¥æ‰‹æ£€æµ‹é€»è¾‘ï¼ˆã€ä¼˜åŒ–4ã€‘æ—¶é—´çª—å£ç´¯è®¡ä½ç§»ï¼Œé¿å…å•å¸§æŠ–åŠ¨ï¼‰
            const currWristX = landmarks[0].x;
            const now = Date.now();

            // ç»´æŠ¤æœ€è¿‘5å¸§çš„æ‰‹è…•Xåæ ‡
            wristXHistory.push(currWristX);
            if (wristXHistory.length > SWIPE_WINDOW) {
                wristXHistory.shift();
            }

            if (wristXHistory.length === SWIPE_WINDOW && (now - lastSwitchTime > COOLDOWN_MS)) {
                // è®¡ç®—æ—¶é—´çª—å£å†…çš„æ€»ä½ç§»ï¼ˆè€Œéå•å¸§å·®å€¼ï¼‰
                const totalDiff = wristXHistory[wristXHistory.length - 1] - wristXHistory[0];
                
                // è§¦å‘æŒ¥æ‰‹åˆ¤å®šï¼šæ€»ä½ç§»è¶…è¿‡é˜ˆå€¼
                if (totalDiff > SWIPE_THRESHOLD) {
                    switchShape(1); // å‘å³æŒ¥ -> ä¸‹ä¸€ä¸ª
                    lastSwitchTime = now;
                    wristXHistory = []; // æ¸…ç©ºå†å²ï¼Œé¿å…è¿ç»­è§¦å‘
                } else if (totalDiff < -SWIPE_THRESHOLD) {
                    switchShape(-1); // å‘å·¦æŒ¥ -> ä¸Šä¸€ä¸ª
                    lastSwitchTime = now;
                    wristXHistory = []; // æ¸…ç©ºå†å²ï¼Œé¿å…è¿ç»­è§¦å‘
                }
            }

            lastWristX = currWristX;

        } else {
            // æ²¡æ£€æµ‹åˆ°æ‰‹ï¼Œé‡ç½®çŠ¶æ€
            handInteractionFactor += (1.0 - handInteractionFactor) * 0.1; // åŠ å¿«å¤ä½é€Ÿåº¦
            lastWristX = null;
            wristXHistory = []; // æ¸…ç©ºå†å²
        }
    });

    // ã€ä¼˜åŒ–5ã€‘æé«˜æ‘„åƒå¤´åˆ†è¾¨ç‡ï¼Œæå‡æ£€æµ‹ç²¾åº¦ï¼ˆæ ¹æ®è®¾å¤‡æ€§èƒ½è°ƒæ•´ï¼‰
    const cameraUtils = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 1280,  // ä»640å‡è‡³1280ï¼Œæ›´é«˜åˆ†è¾¨ç‡
        height: 720,  // ä»480å‡è‡³720ï¼Œæ›´é«˜åˆ†è¾¨ç‡
        facingMode: 'user'
    });
    cameraUtils.start();

    // ================= åŠ¨ç”»å¾ªç¯ï¼ˆã€ä¼˜åŒ–6ã€‘æå‡ç²’å­å“åº”é€Ÿåº¦ï¼‰ =================
    let time = 0;
    function animate() {
        requestAnimationFrame(animate);
        time += 0.01;
        
        // åŠ å¿«é¢œè‰²æ¸å˜é€Ÿåº¦ï¼šä»0.05å‡è‡³0.15
        material.color.lerp(targetColor, 0.15);
        
        // æ•´ä½“æ—‹è½¬åŠ é€Ÿï¼šä»0.15å‡è‡³0.2ï¼Œè§†è§‰æ›´çµåŠ¨
        particles.rotation.y = time * 0.2;
        particles.rotation.x = time * 0.05; // æ–°å¢Xè½´æ—‹è½¬ï¼Œå¢åŠ åŠ¨æ€æ•ˆæœ
        
        const posArr = particles.geometry.attributes.position.array;
        const currentKey = SHAPE_LIST[currentShapeIndex].key;
        const isFireworks = currentKey === 'fireworks';
        
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const ix = i * 3, iy = ix + 1, iz = ix + 2;
            let tx = targetPositions[ix], ty = targetPositions[iy], tz = targetPositions[iz];

            // çƒŸèŠ±ç‰¹æ®ŠåŠ¨æ€
            if (isFireworks) {
                const pulse = 1 + Math.sin(time * 5) * 0.6; // åŠ å¿«çƒŸèŠ±è„‰åŠ¨é€Ÿåº¦
                tx *= pulse; ty *= pulse; tz *= pulse;
            }

            // åº”ç”¨æ‰‹åŠ¿ç¼©æ”¾
            tx *= handInteractionFactor; ty *= handInteractionFactor; tz *= handInteractionFactor;
            
            // å‡å°‘éšæœºå™ªç‚¹ï¼Œé¿å…ç²’å­è¿‡åº¦æŠ–åŠ¨å½±å“è§†è§‰
            tx += (Math.random()-0.5)*0.1; ty += (Math.random()-0.5)*0.1; tz += (Math.random()-0.5)*0.1;

            // åŠ å¿«ç²’å­ç§»åŠ¨é€Ÿåº¦ï¼šä»0.08å‡è‡³0.15ï¼Œç²’å­å“åº”æ›´æ•æ·
            posArr[ix] += (tx - posArr[ix]) * 0.15;
            posArr[iy] += (ty - posArr[iy]) * 0.15;
            posArr[iz] += (tz - posArr[iz]) * 0.15;
        }
        
        particles.geometry.attributes.position.needsUpdate = true;
        renderer.render(scene, camera);
    }
    
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
    
    animate();
</script>
</body>
</html>